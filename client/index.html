<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>SnakeIO</title>
    <link rel="stylesheet" href="./CSS/style.css">
    <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function Button(props){
            return(
                <div id={props.name + "ButtonDiv"}>
                    <button id={"button" + props.name}>{props.text}</button>
                </div>
            )
        }

        function Input(props){
            return(
                <div id={props.name.toLowerCase()}>
                    <div id={props.name + "LabelDiv"}>
                        <label htmlFor={"input" + props.name}>{props.text}</label>
                    </div>
                    <div id={props.name + "InputDiv"}>
                        <input id={"input" + props.name} type={props.type} name={props.name} maxLength={props.maxLength}/>
                    </div>
                </div>
            )
        }

        class Create_session extends React.Component{
            componentDidMount() {
                document.getElementById("buttonnewGame").addEventListener("click", () => {
                    //create a new lobby
                    const url = "http://localhost:3000/create"
                    const request = new Request(url, {
                            method: 'GET'
                        }
                    )

                    fetch(request)
                        .then(response => {
                            // connect the player to the lobby
                            sessionID = response.toString()
                            ws = new WebSocket("ws://localhost:3000/join/" + sessionID + "/name/" + name)
                        })
                        .catch(err => console.log(err.message))
                })
            }

            render() {
                return(
                    <div>
                        <div id="newGameLabelDiv">
                            <label htmlFor="buttonNewGame">Create a game</label>
                        </div>
                        <div id="emptySpaceDiv">
                            <br/>
                        </div>
                        <Button text={"play"} name={"newGame"}/>

                    </div>
                )
            }
        }

        class Join_session extends React.Component{
            componentDidMount() {
                document.getElementById("buttonsessionId").addEventListener("click", () => {
                    // connect to lobby if SessionID is correct

                    const url = "http://localhost:3000/game-info?code=" + sessionID
                    const request = new Request(url, {
                            method: 'GET'
                        }
                    )

                    fetch(request)
                        .then(response => {
                            // look if the lobby with the sessionID is running if yes open ws
                            response.json()
                        })
                        .then(obj => {
                            const isValideId = obj.isValide // boolean if SessionID is valide
                            const isFull = obj.isFull // boolean if there is space for the player to join
                        })
                        .catch(err => console.log(err.message))

                    if(isValideId){
                        if(!isFull){
                            ws = new WebSocket("ws://localhost:3000/join/" + sessionID + "/name/" + name)
                        }else {
                            alert("The lobby with SessionID " + sessionID + " already has no free slots for new players to join")
                        }
                    }else{
                        alert("No lobby with SessionID " + sessionID + " is currently open")
                    }
                })
            }

            render() {
                return(
                    <div>
                        <Input name={"sessionId"} type={"text"} text={"Join a Session"} maxLength={"10"}/>
                        <Button text={"join"} name={"sessionId"}/>
                    </div>
                )
            }
        }

        class Main_menu extends React.Component {
            render(){
                return (
                    <div className="frame">
                        <header>
                            <img src="./assets/img.png" alt="Snake.IO banner image" />
                        </header>
                        <main>
                            <div>
                                <Input name={"Name"} type={"text"} text={"Enter your name: "} maxLength={"10"}/>
                            </div>
                            <div id="enterLobby">
                                <Create_session />
                                <Join_session />
                            </div>
                        </main>
                    </div>
                )
            }
        }

        let player = [
            {name: "Tim", color: "red"},
            {name: "Lukas", color: "green"},
            {name: "Felix", color: "yellow"},
            {name: "Timo", color: "blue"}
        ]

        function TablePlayer(props){
            return(
                <div>
                    <table>
                        <thead>
                        <tr>
                            <th >{props.tableHead1}</th>
                            <th >{props.tableHead2}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {props.data.map((player, i) =>
                            <tr key={i}>
                                <td>{props.data[i].name}</td>
                                <td>{props.data[i].color}</td>
                            </tr>
                        )}
                        </tbody>
                    </table>
                </div>
            )
        }

        function List(){
            return(
                <div>
                    <h2>Player:</h2>
                    <ul>
                        {player.map((player, i) =>
                            <li id={"player" + i}>{player.name}</li>
                        )}
                    </ul>
                </div>
            )
        }

        class Lobby extends React.Component {
            componentDidMount() {
                document.getElementById("buttonexitLobby").addEventListener("click", () => {
                    ReactDOM.render(
                        <Main_menu />,
                        document.getElementById('root')
                    );
                })

                document.getElementById("buttonstartGame").addEventListener("click", () => {
                    ReactDOM.render(
                        <Game />,
                        document.getElementById('root')
                    );
                })
            }

            render() {
                return(
                    <div className="frame">
                        <div>
                            <Button name={"exitLobby"} text={"back"}/>
                        </div>
                        <div id="lobbyHeadlineDIV">
                            <h1 id="lobbyHeadline">Lobby</h1>
                        </div>
                        <div id="lobby" className="noMargin">
                            <div id="sessionIDDIV">
                                <h2 id="sessionIDHeadline" className="noMargin">SessionID:</h2>
                                <p id="sessionIDtext" className="noMargin">X15QW4B</p>
                            </div>
                            <div id="playerTable">
                                <List />
                            </div>
                        </div>
                        <div id="startGameDIV">
                            <Button name={"startGame"} text={"Start"}/>
                        </div>
                    </div>
                )
            }
        }

        class Game extends React.Component {
            componentDidMount() {
                document.getElementById("buttonexitGame").addEventListener("click", () => {
                    ReactDOM.render(
                        <Lobby />,
                        document.getElementById('root')
                    );
                })

                document.addEventListener("keydown", (event) => {
                    switch (event.key){
                        case 'w':
                        case 'a':
                        case 's':
                        case 'd':
                            ws.send(event.key)
                    }
                })
            }

            render() {
                return(
                    <div className="frame">
                        <Button name={"exitGame"} text={"back"}/>
                        <div className="flexed" id="gameScreen">
                            <div id="gameMap">
                                <canvas id="mapCanvas" width={this.props.width} height={this.props.height}>
                                </canvas>
                            </div>
                            <div id="gameScores">
                                <TablePlayer data={player} tableHead1={"Player"} tableHead2={"Score"}/>
                            </div>
                        </div>
                    </div>
                )
            }
        }

        ReactDOM.render(
            <Lobby />,
            document.getElementById('root')
        );

        // values of the input fields
        let sessionID = document.getElementById("inputSessionId").value
        const name = document.getElementById("inputName").value
        let ws
        const cellSize = 40

        function drawChanges(x, y, material){
            const canvasMap = document.getElementById("mapCanvas")
            const context = canvasMap.getContext("2d")

            switch (material) {
                case "#":
                    context.fillStyle = "red"
                    context.fillRect(x, y, 40, 40)
                    break
                case "@":
                    context.fillStyle = "green"
                    context.fillRect(x, y, 40, 40)
                    break
                case " ":
                    context.fillStyle = "blue"
                    context.fillRect(x, y, 40, 40)
                    break
                case "\n":
                    x = 0
                    y += 40
                    break
            }
        }

        function drawGrid(bw, bh, cellSize){
            const canvasMap = document.getElementById("mapCanvas")
            const context = canvasMap.getContext("2d")

            for (let x = 0; x <= bw; x += cellSize) {
                context.moveTo(0.5 + x, 0);
                context.lineTo(0.5 + x, bh);
            }

            for (let x = 0; x <= bh; x += cellSize) {
                context.moveTo(0, 0.5 + x);
                context.lineTo(bw, 0.5 + x);
            }
            context.strokeStyle = "black";

            context.stroke()
        }

        function drawWorld(world, cellSize){
            const canvasMap = document.getElementById("mapCanvas")
            const context = canvasMap.getContext("2d")

            let x = 0
            let y = 0

            // draw the World array
            for (let i = 0; i < world.length; i++) {
                switch (world[i]) {
                    case "#":
                        context.fillStyle = "red"
                        context.fillRect(x, y, cellSize, cellSize)
                        x += cellSize
                        break
                    case "@":
                        context.fillStyle = "green"
                        context.fillRect(x, y, cellSize, cellSize)
                        x += cellSize
                        break
                    case " ":
                        context.fillStyle = "blue"
                        context.fillRect(x, y, cellSize, cellSize)
                        x += cellSize
                        break
                    case "\n":
                        x = 0
                        y += cellSize
                        break
                    default:
                        break
                }
            }
        }

        if ("Websocket" in window){
            ws.onopen = function () {
                // perform Action when connection is opened
                ReactDOM.render(
                    <Lobby />,
                    document.getElementById('root')
                );
            }
            ws.onmessage = function (evt) {
                // finding out width + height of the canvas
                let endOfFirstLine = evt.world.findIndex(element => element === "\n")
                const firstLine = evt.world.slice(0,endOfFirstLine)
                let amountOfLines = 1
                for (let i = 0; i < evt.world.length; i++) {
                    if(evt.world[i] == "\n"){
                        amountOfLines++
                    }
                }

                //render Game World
                ReactDOM.render(
                    <Game  width={firstLine.length * cellSize + 1} height={amountOfLines * cellSize + 1}/>,
                    document.getElementById('root')
                )

                // draw the grid
                drawGrid(firstLine.length * cellSize + 1, amountOfLines * cellSize + 1, cellSize)

                // draw the world string
                drawWorld(evt.world.length, cellSize)

                // draw the
                for (let i = 0; i < evt.replace.length; i++) {
                    let x = evt.replace.pos.x
                    let y = evt.replace.pos.y
                    let material = evt.replace.mat

                    drawChanges(x, y, material)
                }


            }
            ws.onclose = function () {
                // websocket is closed.
                alert("Connection is closed...");
                ReactDOM.render(
                    <Main_menu />,
                    document.getElementById('root')
                );
            };
            ws.onerror = function (error){
                console.log("Error: " + error)
            }
        }else {
            // The browser doesn't support WebSocket
            alert("WebSocket NOT supported by your Browser!");
        }
    </script>
</body>

</html>